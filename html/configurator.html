<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Ïû•Ïπò ÏÑ§Ï†ï (Config) - SmartFarm</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(20, 20, 25, 0.6);
            --primary: #00f2ff;
            --secondary: #7000ff;
            --success: #00ff9d;
            --warning: #ffb800;
            --danger: #ff0055;
            --text-main: #ffffff;
            --text-muted: #8899ac;
            --border: rgba(255, 255, 255, 0.08);
            --glass: blur(20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        /* --- Premium Pull-down Navigation --- */
        .top-navbar {
            height: 60px;
            background: rgba(10, 10, 12, 0.95);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 3000;
        }

        .logo {
            font-weight: 800;
            font-size: 1.3rem;
            letter-spacing: -0.5px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .logo span {
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Mobile Menu (Pull-down Overlay) */
        .mobile-menu-overlay {
            position: fixed;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 8, 0.98);
            backdrop-filter: blur(30px);
            z-index: 2500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            transition: top 0.5s cubic-bezier(0.7, 0, 0.3, 1);
            opacity: 0;
        }

        .mobile-menu-overlay.open {
            top: 0;
            opacity: 1;
        }

        .mobile-nav-item {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.3s;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-toggle {
            display: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            position: relative;
            z-index: 3100;
        }

        /* --- Main Content (Mobile-First) --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        header {
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1.5rem;
            background: rgba(10, 10, 12, 0.6);
            backdrop-filter: var(--glass);
            border-bottom: 1px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .mobile-toggle {
                display: flex;
            }

            .main-container {
                grid-template-columns: 1fr !important;
            }
        }

        @media (min-width: 769px) {
            header {
                flex-direction: row !important;
                justify-content: space-between;
                align-items: center;
                padding: 1.5rem 2rem;
            }
        }

        header {
            padding: 1.5rem 2rem;
            background: rgba(10, 10, 12, 0.6);
            backdrop-filter: var(--glass);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #aaa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        /* --- Buttons & Inputs --- */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            box-shadow: 0 8px 20px -5px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            border: none;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        select,
        input {
            background: #1E293B;
            border: 1px solid var(--border);
            padding: 0.8rem;
            border-radius: 10px;
            color: white;
            outline: none;
            font-size: 0.9rem;
        }

        select:focus,
        input:focus {
            border-color: var(--primary);
        }

        /* --- Layout --- */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            padding: 2rem;
            flex-grow: 1;
            width: 100%;
            overflow-y: auto;
        }

        .config-sidebar {
            background: var(--bg-panel);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            height: fit-content;
            max-height: 100%;
            overflow-y: auto;
        }

        .editor-panel {
            background: var(--bg-panel);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* --- Cards --- */
        .config-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: border-color 0.3s;
        }

        .config-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-main);
        }

        .grid-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.75rem;
            color: var(--text-dim);
            font-weight: 600;
        }

        .pin-badge {
            background: var(--secondary);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            font-family: monospace;
        }

        /* --- Node List Item --- */
        .node-item {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .node-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .node-item.active {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--primary);
        }

        .node-item .id {
            font-weight: 700;
            color: var(--primary);
            font-size: 1rem;
        }

        .node-item .meta {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        /* --- Footer --- */
        .footer {
            padding: 2rem;
            background: rgba(15, 23, 42, 0.9);
            border-top: 1px solid var(--border);
        }

        #json-output {
            background: #000;
            color: #10B981;
            padding: 1.5rem;
            border-radius: 12px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            border: 1px solid var(--border);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <!-- Top Navigation Bar -->
    <nav class="top-navbar">
        <div class="logo" onclick="location.href='/'">
            <i data-lucide="leaf" style="color:var(--primary)"></i>
            <span>MQ</span>net SmartFarm
        </div>

        <div class="nav-links">
            <a href="index.html" class="nav-item">ÎåÄÏãúÎ≥¥Îìú</a>
            <a href="cctv.html" class="nav-item">CCTV</a>
            <a href="dashboard.html" class="nav-item">Î™®ÎãàÌÑ∞ÎßÅ</a>
            <a href="history.html" class="nav-item">Î∂ÑÏÑùÏùºÏßÄ</a>
            <a href="infra_tree.html" class="nav-item">Ïù∏ÌîÑÎùº</a>
            <a href="recipe_manager.html" class="nav-item">ÏûêÎèôÌôî</a>
        </div>

        <div class="mobile-toggle" id="menu-toggle">
            <i data-lucide="menu" id="menu-icon"></i>
        </div>
    </nav>

    <!-- Premium Pull-down Mobile Overlay -->
    <div class="mobile-menu-overlay" id="mobile-menu">
        <a href="index.html" class="mobile-nav-item">ÎåÄÏãúÎ≥¥Îìú</a>
        <a href="cctv.html" class="mobile-nav-item">Ïã§ÏãúÍ∞Ñ CCTV</a>
        <a href="dashboard.html" class="mobile-nav-item">ÏÑºÏÑú Î™®ÎãàÌÑ∞ÎßÅ</a>
        <a href="history.html" class="mobile-nav-item">Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÏùºÏßÄ</a>
        <a href="infra_tree.html" class="mobile-nav-item">Ïù∏ÌîÑÎùº Í¥ÄÎ¶¨</a>
        <a href="recipe_manager.html" class="mobile-nav-item">ÏûêÎèôÌôî ÏÑ§Ï†ï</a>
        <a href="help.html" class="mobile-nav-item">ÎèÑÏõÄÎßê Center</a>
    </div>

    <main class="main-content">
        <header>
            <div class="page-title">
                <h1>Ïû•Ïπò ÏÑ§Ï†ï (Configurator)</h1>
            </div>
            <div class="toolbar">
                <button class="btn"
                    style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s; backdrop-filter: blur(10px);"
                    onclick="document.getElementById('file-input').click()">üìÇ ÏÑ§Ï†ï Î∂àÎü¨Ïò§Í∏∞</button>
                <input type="file" id="file-input" style="display: none;" onchange="handleFileSelect(event)">

                <button class="btn"
                    style="background: var(--primary); border: none; color: #000; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; transition: all 0.3s; box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);"
                    onclick="promptNewNode()">+ ÎÖ∏Îìú Ï∂îÍ∞Ä</button>
                <button class="btn"
                    style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s; backdrop-filter: blur(10px);"
                    onclick="downloadConfig()">üíæ ÌååÏùº Ï†ÄÏû•</button>
                <button class="btn"
                    style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s; backdrop-filter: blur(10px);"
                    onclick="copyJson()">üìã JSON Î≥µÏÇ¨</button>
            </div>
        </header>

        <div class="main-container">
            <!-- Sidebar -->
            <div class="config-sidebar">
                <h3 class="section-title">Ïö¥Ïö© Ï§ëÏù∏ ÎÖ∏Îìú Î™©Î°ù</h3>
                <div id="node-list">
                    <!-- Node items -->
                </div>
            </div>

            <!-- Editor -->
            <div class="editor-panel">
                <div id="empty-state" style="text-align: center; padding: 5rem; color: var(--text-muted);">
                    <div style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem;">üì°</div>
                    <p>Î™©Î°ùÏóêÏÑú ÎÖ∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÏó¨ ÏÑ§Ï†ïÏùÑ Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî.</p>
                </div>

                <div id="editor-content" style="display: none;">
                    <div class="section-title">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 1.5rem;">üì¶</span>
                            <input type="text" id="node-id-display"
                                style="background:transparent; border:none; padding:0; font-size: 1.8rem; font-weight: 800; color:var(--primary); width: 120px;">
                        </div>
                        <div id="node-context-info"
                            style="margin-left:auto; text-align:right; font-size:0.8rem; color:var(--text-muted); display:flex; flex-direction:column;">
                            <!-- Date/Stage injected here -->
                        </div>
                        <button class="btn"
                            style="background: rgba(255, 0, 85, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 5px 15px; border-radius: 8px; margin-left: 20px; cursor: pointer;"
                            onclick="deleteNode(activeNodeIndex)">ÎÖ∏Îìú ÏÇ≠Ï†ú (Delete)</button>
                    </div>

                    <!-- Sensors -->
                    <div class="section-title"
                        style="margin-top: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                        <span>üå°Ô∏è ÏÑºÏÑú ÏÑ§Ï†ï (Input)</span>
                        <button class="btn"
                            style="background: var(--primary); border: none; color: #000; padding: 5px 15px; border-radius: 8px; font-weight: 700; cursor: pointer;"
                            onclick="addSensor()">+ ÏÑºÏÑú Ï∂îÍ∞Ä</button>
                    </div>
                    <div id="sensor-list"></div>

                    <!-- Actuators -->
                    <div class="section-title"
                        style="margin-top: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                        <span>‚öôÔ∏è Íµ¨ÎèôÍ∏∞ ÏÑ§Ï†ï (Output)</span>
                        <button class="btn"
                            style="background: var(--primary); border: none; color: #000; padding: 5px 15px; border-radius: 8px; font-weight: 700; cursor: pointer;"
                            onclick="addActuator()">+ Íµ¨ÎèôÍ∏∞ Ï∂îÍ∞Ä</button>
                    </div>
                    <div id="actuator-list"></div>
                </div>
            </div>
        </div>

        <div class="footer"
            style="padding: 2rem; background: rgba(10, 10, 12, 0.9); border-top: 1px solid var(--border);">
            <h3 class="section-title">üìÑ JSON Preview</h3>
            <pre id="json-output"
                style="background: #000; color: var(--primary); padding: 1.5rem; border-radius: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; border: 1px solid var(--border);">// No data</pre>
        </div>
    </main>

    <script>
        let nodes = [];
        let zoneConfigs = [];
        let catalog = {
            sensors: [],
            actuators: []
        };
        let activeNodeIndex = -1;

        async function loadZoneConfigs() {
            try {
                const response = await fetch('/data/zone_config.json');
                if (response.ok) { zoneConfigs = await response.json(); }
            } catch (e) { console.warn("Zone config load failed"); }
        }

        async function loadCatalog() {
            try {
                const response = await fetch('/data/catalog_device.json');
                if (response.ok) { catalog = await response.json(); }
            } catch (e) { console.warn("Catalog load failed"); }
        }

        async function loadExistingConfig() {
            try {
                const response = await fetch('/data/config.json');
                if (response.ok) {
                    nodes = await response.json();
                    renderNodeList();
                    if (nodes.length > 0) setActiveNode(0);
                    return true;
                }
            } catch (e) { }
            return false;
        }

        function handleFileSelect(evt) {
            const file = evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    nodes = JSON.parse(e.target.result);
                    renderNodeList();
                    if (nodes.length > 0) setActiveNode(0);
                } catch (err) { alert("JSON Error"); }
            };
            reader.readAsText(file);
        }

        function renderNodeList() {
            const list = document.getElementById('node-list');
            list.innerHTML = nodes.map((n, i) => `
                <div class="node-item ${i === activeNodeIndex ? 'active' : ''}" onclick="setActiveNode(${i})">
                    <div class="id">${n.id}</div>
                    <div class="meta">${(n.sensors || []).length} Sensors / ${(n.actuators || []).length} Actuators</div>
                </div>
            `).join('');
        }

        function setActiveNode(index) {
            activeNodeIndex = index;
            renderNodeList();

            if (index === -1) {
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('editor-content').style.display = 'none';
                updateJsonOutput();
                return;
            }
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('editor-content').style.display = 'block';

            const node = nodes[index];
            document.getElementById('node-id-display').value = node.id;

            // Context Info Update
            const today = new Date().toISOString().split('T')[0];
            let stageInfo = "Zone info not found";

            if (node.id && node.id.length >= 2) {
                const zoneId = node.id.substring(0, 2);
                const zone = zoneConfigs.find(z => z.id === zoneId);
                if (zone) {
                    const stage = getCurrentStage(zone.schedule || {});
                    stageInfo = `Zone: ${zone.name || zoneId} | Stage: <span style="color:var(--accent); font-weight:bold">${stage.toUpperCase()}</span>`;
                }
            }

            document.getElementById('node-context-info').innerHTML = `
                <span>Today: ${today}</span>
                <span>${stageInfo}</span>
            `;

            renderSensors();
            renderActuators();
            updateJsonOutput();
        }

        function getCurrentStage(schedule) {
            if (!schedule || Object.keys(schedule).length === 0) return "n/a";
            const now = new Date();
            const dates = Object.entries(schedule)
                .map(([k, v]) => ({ key: k, date: new Date(v) }))
                .sort((a, b) => b.date - a.date);
            for (let d of dates) {
                if (now >= d.date) return d.key;
            }
            return "sowing";
        }

        function updateNodeId(newId) {
            if (activeNodeIndex === -1) return;
            nodes[activeNodeIndex].id = newId.toUpperCase();
            renderNodeList();
            updateJsonOutput();
        }

        function promptNewNode() {
            const id = prompt("ÏÉàÎ°úÏö¥ ÎÖ∏Îìú IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: AA01):");
            if (id) {
                nodes.push({ id: id.toUpperCase(), sensors: [], actuators: [] });
                setActiveNode(nodes.length - 1);
            }
        }

        function deleteNode(idx) {
            if (confirm("Ï†ïÎßêÎ°ú Ïù¥ ÎÖ∏ÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                nodes.splice(idx, 1);
                setActiveNode(nodes.length > 0 ? 0 : -1);
            }
        }

        function getDevicePins(node) {
            let pins = {
                analog: ["GPIO0(ADC)", "GPIO1(ADC)", "GPIO2(ADC)", "GPIO3(ADC)", "GPIO4(ADC)"],
                digital: ["GPIO5", "GPIO6", "GPIO7", "GPIO8", "GPIO9", "GPIO10", "GPIO11", "GPIO12", "GPIO13", "GPIO14", "GPIO15", "GPIO16"]
            };
            let sPins = [];
            let aPins = [];
            (node.sensors || []).forEach(s => sPins.push(pins[s.type]?.shift() || "No Pin"));
            (node.actuators || []).forEach(a => aPins.push(pins[a.type]?.shift() || "No Pin"));
            return { sPins, aPins };
        }

        function renderSensors() {
            const list = document.getElementById('sensor-list');
            const node = nodes[activeNodeIndex];
            const { sPins } = getDevicePins(node);

            list.innerHTML = (node.sensors || []).map((s, i) => `
                <div class="config-card">
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="input-group" style="flex: 2; min-width: 200px;">
                            <label>Device Catalog</label>
                            <select onchange="onDeviceSelect('sensors', ${i}, this.value)" style="width: 100%;">
                                <option value="">-- Select --</option>
                                ${catalog.sensors.map(c => `<option value="${c.name}" ${c.name === s.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="input-group" style="flex: 2; min-width: 200px;">
                            <label>ID & Pin</label>
                            <div style="display:flex; align-items:center; gap:8px">
                                <input type="text" value="${s.id}" oninput="updateDevice('sensors', ${i}, 'id', this.value)" style="flex:1; padding:0.5rem">
                                <span class="pin-badge">${sPins[i]}</span>
                            </div>
                        </div>
                        <div class="input-group" style="flex: 0 0 80px;">
                            <label>Min</label>
                            <input type="number" value="${s.min}" oninput="updateDevice('sensors', ${i}, 'min', Number(this.value))" style="width: 100%;">
                        </div>
                        <div class="input-group" style="flex: 0 0 80px;">
                            <label>Max</label>
                            <input type="number" value="${s.max}" oninput="updateDevice('sensors', ${i}, 'max', Number(this.value))" style="width: 100%;">
                        </div>
                        <div class="input-group" style="margin-left: auto;">
                            <button class="btn-danger" style="padding: 0.8rem 1rem;" onclick="deleteDevice('sensors', ${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderActuators() {
            const list = document.getElementById('actuator-list');
            const node = nodes[activeNodeIndex];
            const { aPins } = getDevicePins(node);

            list.innerHTML = (node.actuators || []).map((a, i) => `
                <div class="config-card">
                    <div class="grid-row">
                        <div class="input-group">
                            <label>Device Catalog</label>
                            <select onchange="onDeviceSelect('actuators', ${i}, this.value)">
                                <option value="">-- Select --</option>
                                ${catalog.actuators.map(c => `<option value="${c.name}" ${c.name === a.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ID & Pin</label>
                            <div style="display:flex; align-items:center; gap:8px">
                                <input type="text" value="${a.id}" oninput="updateDevice('actuators', ${i}, 'id', this.value)" style="flex:1; padding:0.5rem">
                                <span class="pin-badge">${aPins[i]}</span>
                            </div>
                        </div>
                        <button class="btn-danger" style="margin-top:20px; padding:5px" onclick="deleteDevice('actuators', ${i})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function onDeviceSelect(type, idx, name) {
            const item = catalog[type].find(c => c.name === name);
            if (item) {
                nodes[activeNodeIndex][type][idx] = { ...nodes[activeNodeIndex][type][idx], ...item };
                setActiveNode(activeNodeIndex);
            }
        }

        function updateDevice(type, idx, key, val) {
            nodes[activeNodeIndex][type][idx][key] = val;
            updateJsonOutput();
        }

        function addSensor() { nodes[activeNodeIndex].sensors.push({ id: nodes[activeNodeIndex].id + '00' + (nodes[activeNodeIndex].sensors.length + 1), name: '', type: 'analog', min: 0, max: 100 }); renderSensors(); updateJsonOutput(); }
        function addActuator() { nodes[activeNodeIndex].actuators.push({ id: nodes[activeNodeIndex].id + '10' + (nodes[activeNodeIndex].actuators.length + 1), name: '', type: 'digital' }); renderActuators(); updateJsonOutput(); }

        function deleteDevice(type, idx) { nodes[activeNodeIndex][type].splice(idx, 1); setActiveNode(activeNodeIndex); }

        function updateNodeId(newId) {
            if (activeNodeIndex === -1) return;
            const oldId = nodes[activeNodeIndex].id;
            const upId = newId.toUpperCase();
            nodes[activeNodeIndex].id = upId;

            // ÌïòÏúÑ Ïû•Ïπò ID ÎèôÍ∏∞Ìôî (Í∏∞Ï°¥ IDÍ∞Ä ÎÖ∏Îìú IDÎ°ú ÏãúÏûëÌïòÎäî Í≤ΩÏö∞Îßå)
            if (nodes[activeNodeIndex].sensors) {
                nodes[activeNodeIndex].sensors.forEach(s => {
                    if (s.id.startsWith(oldId)) s.id = s.id.replace(oldId, upId);
                });
            }
            if (nodes[activeNodeIndex].actuators) {
                nodes[activeNodeIndex].actuators.forEach(a => {
                    if (a.id.startsWith(oldId)) a.id = a.id.replace(oldId, upId);
                });
            }

            renderNodeList();
            updateJsonOutput();
        }

        function updateJsonOutput() { document.getElementById('json-output').textContent = JSON.stringify(nodes, null, 4); }
        function copyJson() { navigator.clipboard.writeText(document.getElementById('json-output').textContent).then(() => alert("Copied!")); }
        function downloadConfig() {
            const blob = new Blob([document.getElementById('json-output').textContent], { type: "application/json" });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `config.json`; a.click();
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Premium Pull-down Menu Toggle
            const menuToggle = document.getElementById('menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    const isOpen = mobileMenu.classList.toggle('open');
                    menuIcon.setAttribute('data-lucide', isOpen ? 'x' : 'menu');
                    lucide.createIcons();
                    document.body.style.overflow = isOpen ? 'hidden' : 'auto';
                });
            }

            lucide.createIcons();
            document.getElementById('node-id-display').addEventListener('input', (e) => updateNodeId(e.target.value));

            await loadCatalog();
            await loadZoneConfigs();
            await loadExistingConfig();

            const params = new URLSearchParams(window.location.search);
            const targetNodeId = params.get('node');
            if (targetNodeId) {
                const index = nodes.findIndex(n => n.id === targetNodeId);
                if (index !== -1) { setActiveNode(index); }
            }
        });
    </script>

</body>

</html>