<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„° ë¶„ì„ ë° ì˜ë† ì¼ì§€ (Data & Analytics) - SmartFarm</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(20, 20, 25, 0.6);
            --primary: #00f2ff;
            --secondary: #7000ff;
            --success: #00ff9d;
            --warning: #ffb800;
            --danger: #ff0055;
            --text-main: #ffffff;
            --text-muted: #8899ac;
            --border: rgba(255, 255, 255, 0.08);
            --glass: blur(20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(112, 0, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 242, 255, 0.05) 0%, transparent 40%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 80px;
            background: rgba(10, 10, 12, 0.8);
            backdrop-filter: var(--glass);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 0;
            z-index: 100;
            transition: width 0.3s ease;
        }

        .sidebar:hover {
            width: 240px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
            flex-shrink: 0;
        }

        .nav-item {
            width: 100%;
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.2s;
            position: relative;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--text-main);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.03), transparent);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .nav-icon {
            margin-right: 1.5rem;
            flex-shrink: 0;
        }

        .nav-label {
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.2s;
            font-weight: 500;
        }

        .sidebar:hover .nav-label {
            opacity: 1;
            transition-delay: 0.1s;
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            padding: 2rem;
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 2rem;
            overflow-y: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #fff, #aaa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- Analysis Grid --- */
        .analysis-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1.5rem;
            height: 100%;
        }

        .card {
            background: var(--bg-panel);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Chart Area */
        .chart-container {
            flex: 1;
            position: relative;
            width: 100%;
        }

        /* Journal List */
        .journal-list {
            flex: 1;
            overflow-y: auto;
            border-top: 1px solid var(--border);
            margin-top: 10px;
            padding-top: 10px;
        }

        .journal-entry {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            border-left: 3px solid var(--text-muted);
        }

        .journal-entry.work {
            border-left-color: var(--primary);
        }

        .journal-entry.harvest {
            border-left-color: var(--success);
        }

        .journal-entry.pest {
            border-left-color: var(--danger);
        }

        .journal-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .journal-content {
            color: var(--text-main);
        }

        /* Controls */
        .control-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        input,
        select,
        textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 6px;
        }

        /* Fix Calendar Icon Visibility */
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        button.btn-primary {
            background: var(--primary);
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <nav class="sidebar">
        <div class="logo"><span>MQ</span>net</div>
        <a href="index.html" class="nav-item">
            <i data-lucide="layout-dashboard" class="nav-icon"></i>
            <span class="nav-label">ëŒ€ì‹œë³´ë“œ (Overview)</span>
        </a>
        <a href="cctv.html" class="nav-item">
            <i data-lucide="camera" class="nav-icon"></i>
            <span class="nav-label">ì˜ìƒ ê´€ì œ (CCTV)</span>
        </a>
        <a href="dashboard.html" class="nav-item">
            <i data-lucide="activity" class="nav-icon"></i>
            <span class="nav-label">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</span>
        </a>
        <a href="history.html" class="nav-item active">
            <i data-lucide="file-text" class="nav-icon"></i>
            <span class="nav-label">ë¶„ì„ ë° ì¼ì§€</span>
        </a>
        <a href="help.html" class="nav-item">
            <i data-lucide="help-circle" class="nav-icon"></i>
            <span class="nav-label">ë„ì›€ë§ (Help)</span>
        </a>
        <a href="infra_tree.html" class="nav-item">
            <i data-lucide="network" class="nav-icon"></i>
            <span class="nav-label">ì¸í”„ë¼ ê´€ë¦¬</span>
        </a>
        <a href="configurator.html" class="nav-item">
            <i data-lucide="settings" class="nav-icon"></i>
            <span class="nav-label">ì¥ì¹˜ ì„¤ì •</span>
        </a>
        <a href="recipe_manager.html" class="nav-item">
            <i data-lucide="workflow" class="nav-icon"></i>
            <span class="nav-label">ìë™í™”/ë ˆì‹œí”¼</span>
        </a>
    </nav>

    <main class="main-content">
        <header>
            <div class="page-title">
                <h1>ë°ì´í„° ë¶„ì„ ë° ì˜ë† ì¼ì§€ (Analytics & Journal)</h1>
                <p>Data-driven Farming & Record Keeping</p>
            </div>
            <div class="control-bar">
                <input type="date" id="date-picker" onchange="loadData()">
                <select id="zone-select">
                    <option value="A">Zone A (ìƒì¶”)</option>
                    <option value="B">Zone B (ìœ¡ë¬˜)</option>
                </select>
                <button class="btn-primary" onclick="loadData()">ì¡°íšŒ</button>
            </div>
        </header>

        <div class="analysis-grid">
            <!-- Chart Section -->
            <div class="card" style="grid-column: 1 / 2; grid-row: 1 / 2;">
                <div class="card-header">
                    <div class="card-title"><i data-lucide="line-chart"></i> í™˜ê²½ ë°ì´í„° ì¶”ì„¸ (Temp & Humidity)</div>
                    <select style="width: 120px;">
                        <option>ì˜¨ë„/ìŠµë„</option>
                        <option>CO2/ì¼ì¡°ëŸ‰</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="envChart"></canvas>
                </div>
            </div>

            <!-- Comparison / Insight Section -->
            <div class="card" style="grid-column: 1 / 2; grid-row: 2 / 3;">
                <div class="card-header">
                    <div class="card-title">
                        <i data-lucide="bar-chart-2"></i> ìƒìœ¡ ë¹„êµ ë° ì—ë„ˆì§€ ì†Œë¹„
                        <button onclick="runAnalysisAndOpen()" id="ai-btn"
                            style="margin-left:auto; font-size:0.7rem; padding:4px 12px; background:linear-gradient(135deg, var(--secondary), var(--primary)); border:none; color:white; border-radius:20px; cursor:pointer; font-weight:600; box-shadow:0 0 10px rgba(112,0,255,0.4); display:flex; align-items:center; gap:5px;">
                            <i data-lucide="sparkles" style="width:12px; height:12px;"></i> AI ë¶„ì„ ì‹¤í–‰
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>

            <!-- Journal Section -->
            <div class="card" style="grid-column: 2 / 3; grid-row: 1 / 3;">
                <div class="card-header">
                    <div class="card-title"><i data-lucide="book-open"></i> ìŠ¤ë§ˆíŠ¸ ì˜ë† ì¼ì§€</div>
                    <button class="btn-primary" onclick="addJournal()" style="font-size:0.8rem; padding:5px 10px;">+
                        ê¸°ë¡</button>
                </div>

                <!-- Quick input -->
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <select id="log-type" style="width:100%; margin-bottom:5px;">
                        <option value="work">ğŸ› ï¸ ì¼ë°˜ ì‘ì—… (Maintenance)</option>
                        <option value="harvest">ğŸŒ¾ ìˆ˜í™• (Harvest)</option>
                        <option value="pest">ğŸ› ë³‘í•´ì¶© ë°©ì œ (Pest Control)</option>
                    </select>
                    <textarea id="log-content" placeholder="ì‘ì—… ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                        style="width:100%; height:60px; resize:none;"></textarea>
                </div>

                <div class="journal-list" id="journal-container">
                    <!-- Dynamic Entries -->
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        var aiCharts = []; // Move to global top scope

        // --- Date Init ---
        document.getElementById('date-picker').valueAsDate = new Date();

        // --- Chart 1: Environment ---
        const ctxEnv = document.getElementById('envChart').getContext('2d');
        const envChart = new Chart(ctxEnv, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [
                    {
                        label: 'ì˜¨ë„ (Â°C)',
                        data: [18, 17, 19, 24, 25, 21, 19],
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'ìŠµë„ (%)',
                        data: [60, 65, 55, 45, 40, 55, 62],
                        borderColor: '#7000ff',
                        backgroundColor: 'rgba(112, 0, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8899ac' } } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8899ac' } },
                    x: { grid: { display: false }, ticks: { color: '#8899ac' } }
                }
            }
        });

        // --- Chart 2: Growth vs Energy ---
        const ctxGrowth = document.getElementById('growthChart').getContext('2d');
        const growthChart = new Chart(ctxGrowth, {
            type: 'bar',
            data: {
                labels: [], // Dynamic
                datasets: [
                    {
                        label: 'ìƒì¥ë¥  (Growth Ratio %)',
                        data: [],
                        backgroundColor: '#00ff9d',
                        yAxisID: 'y',
                    },
                    {
                        label: 'ì „ë ¥ ì†Œë¹„ (kWh)', // Still Dummy for now
                        data: [],
                        backgroundColor: '#ffb800',
                        yAxisID: 'y1',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8899ac' } } },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#00ff9d' },
                        title: { display: true, text: 'ìƒì¥ë¥  (%)', color: '#00ff9d' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#ffb800' },
                        title: { display: true, text: 'ì „ë ¥ (kWh)', color: '#ffb800' }
                    },
                    x: { grid: { display: false }, ticks: { color: '#8899ac' } }
                }
            }
        });

        async function fetchGrowthData() {
            try {
                const res = await fetch('/api/growth');
                if (!res.ok) return;

                const logs = await res.json();

                // Process Data: group by date or just show all points
                // Simple version: Show last 7 entries
                const recentLogs = logs.slice(-7);

                const labels = recentLogs.map(l => l.date.substring(5, 10)); // MM-DD
                const ratios = recentLogs.map(l => l.ratio);

                // Dummy Energy Data (Random for demo)
                const energies = recentLogs.map(() => Math.floor(Math.random() * 10) + 10);

                growthChart.data.labels = labels;
                growthChart.data.datasets[0].data = ratios;
                growthChart.data.datasets[1].data = energies;
                growthChart.update();

            } catch (e) {
                console.error("Growth Data Error: ", e);
            }
        }

        // Load initial data
        fetchGrowthData();

        // --- Journal Logic ---
        function renderJournal(journals) {
            const container = document.getElementById('journal-container');
            if (journals.length === 0) {
                container.innerHTML = `<div style="color:var(--text-muted); text-align:center; padding:20px;">ê¸°ë¡ëœ ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }
            container.innerHTML = journals.map(j => `
                <div class="journal-entry ${j.type}">
                    <div class="journal-date">${j.date}</div>
                    <div class="journal-content">${j.content}</div>
                </div>
            `).join('');
        }

        async function fetchJournal() {
            try {
                const res = await fetch('/api/journal');
                if (res.ok) {
                    const journals = await res.json();
                    renderJournal(journals);
                }
            } catch (e) {
                console.error("Journal Load Error:", e);
            }
        }

        async function addJournal() {
            const type = document.getElementById('log-type').value;
            const content = document.getElementById('log-content').value;
            if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const now = new Date().toLocaleString('ko-KR'); // Format nicely
            const entry = { type, date: now, content };

            try {
                const res = await fetch('/api/journal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });

                if (res.ok) {
                    document.getElementById('log-content').value = "";
                    fetchJournal(); // Refresh list
                } else {
                    alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error(e);
                alert("ì„œë²„ ì˜¤ë¥˜: " + e.message);
            }
        }

        // Initial Load
        fetchJournal();

        async function loadData() {
            const dateInput = document.getElementById('date-picker').value;
            if (!dateInput) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            try {
                // Fetch from Python Backend API
                const res = await fetch(`/api/history?date=${dateInput}`);
                if (!res.ok) throw new Error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

                const data = await res.json();

                // ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°
                if (data.temp.length === 0 && data.humi.length === 0) {
                    alert(`${dateInput} ë‚ ì§œì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }

                // Update Chart
                // labels: ì‹œê°„ì¶• (ê°„ë‹¨íˆ ëª¨ë“  ë°ì´í„°ì˜ ì‹œê°„ì„ í•©ì³ì„œ ì •ë ¬í•˜ê±°ë‚˜, í•˜ë‚˜ë¥¼ ê¸°ì¤€)
                // ì—¬ê¸°ì„œëŠ” temp ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ì¶• ì¬ì„¤ì •
                const labels = data.temp.map(d => d.t);
                const temps = data.temp.map(d => d.y);
                const humis = data.humi.map(d => d.y); // ì£¼ì˜: ì‹œê°„ì¶•ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ, ì‹¤ì œë¡  ë§¤ì¹­ í•„ìš”

                envChart.data.labels = labels;
                envChart.data.datasets[0].data = temps; // Temp
                envChart.data.datasets[1].data = humis; // Humi (Optional: might mismatch length)

                envChart.update();
                alert("ë°ì´í„° ì¡°íšŒ ì™„ë£Œ!");

            } catch (e) {
                console.error(e);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + e.message);
            }
        }

        renderJournal();

        // --- AI Report Logic (v2.5: Dynamic Chart.js) ---

        async function runAnalysisAndOpen() {
            const btn = document.getElementById('ai-btn');
            const originalHTML = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = `<span style="animation: spin 1s linear infinite;">â³</span> AI ê³„ì‚° ì¤‘...`;

                const res = await fetch('/api/run_model', { method: 'POST' });
                if (!res.ok) throw new Error("ë¶„ì„ ì„œë²„ ì˜¤ë¥˜");
                const data = await res.json();
                if (!data.success) throw new Error(data.error || "ë¶„ì„ ì‹¤íŒ¨");

                openAIModalWithData(data);
            } catch (e) {
                alert("ë¶„ì„ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function openAIModalWithData(data) {
            document.getElementById('aiModal').style.display = 'flex';
            if (window.aiCharts && Array.isArray(window.aiCharts)) {
                window.aiCharts.forEach(c => { if (c) c.destroy(); });
            }
            window.aiCharts = [];

            const commonOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#888', font: { size: 10 } } } },
                scales: {
                    x: { ticks: { color: '#555', font: { size: 9 } }, grid: { display: false } },
                    y: { ticks: { color: '#555', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.02)' } }
                }
            };

            const chartsConfig = [
                {
                    id: 'aiC1', type: 'line', label: 'ì„±ì¥ì¶”ì„¸', data: data.dates.map(d => {
                        const idx = data.measured_growth.dates.indexOf(d);
                        return idx !== -1 ? data.measured_growth.ratios[idx] : null;
                    }), color: '#ff4b5c'
                },
                {
                    id: 'aiC2', type: 'line', datasets: [
                        { label: 'ì˜¨ë„', data: data.temp, borderColor: '#ffa726' },
                        { label: 'ìŠµë„', data: data.humi, borderColor: '#29b6f6' }
                    ]
                },
                { id: 'aiC3', type: 'bar', label: 'ê´‘ëŸ‰(PPFD)', data: data.light, color: 'rgba(255,235,59,0.4)' },
                {
                    id: 'aiC4', type: 'line', datasets: [
                        { label: 'EC', data: data.ec, borderColor: '#ba68c8' },
                        { label: 'pH', data: data.ph, borderColor: '#4db6ac' }
                    ]
                }
            ];

            chartsConfig.forEach(cfg => {
                const ctx = document.getElementById(cfg.id).getContext('2d');
                const datasets = cfg.datasets || [{ label: cfg.label, data: cfg.data, borderColor: cfg.color, backgroundColor: cfg.color, tension: 0.3 }];
                aiCharts.push(new Chart(ctx, { type: cfg.type, data: { labels: data.dates, datasets }, options: commonOptions }));
            });
        }

        function closeAIModal() { document.getElementById('aiModal').style.display = 'none'; }

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
            .ai-box { height: 140px; margin-bottom: 20px; background: rgba(255,255,255,0.01); border-radius: 8px; padding: 10px; }
        `;
        document.head.appendChild(style);
    </script>

    <div id="aiModal"
        style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.92); backdrop-filter:blur(20px); justify-content:center; align-items:flex-start; overflow-y:auto; padding:40px 20px;">
        <div
            style="max-width:700px; width:100%; background:#08080a; border:1px solid rgba(255,255,255,0.05); border-radius:30px; padding:30px; box-shadow:0 40px 100px rgba(0,0,0,0.9);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-size:1.1rem; color:#fff; display:flex; align-items:center; gap:10px;"><i
                        data-lucide="sparkles" style="color:var(--primary)"></i> AI ë¶„ì„ ë¦¬í¬íŠ¸</h2>
                <button onclick="closeAIModal()"
                    style="background:none; border:none; color:#555; cursor:pointer; font-size:24px;">&times;</button>
            </div>
            <div class="ai-box"><canvas id="aiC1"></canvas></div>
            <div class="ai-box"><canvas id="aiC2"></canvas></div>
            <div class="ai-box"><canvas id="aiC3"></canvas></div>
            <div class="ai-box"><canvas id="aiC4"></canvas></div>
        </div>
    </div>
</body>

</html>