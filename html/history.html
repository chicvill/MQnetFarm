<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ë¶„ì„ ì¼ì§€ (History) - SmartFarm</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(20, 20, 25, 0.6);
            --primary: #00f2ff;
            --secondary: #7000ff;
            --success: #00ff9d;
            --warning: #ffb800;
            --danger: #ff0055;
            --text-main: #ffffff;
            --text-muted: #8899ac;
            --border: rgba(255, 255, 255, 0.08);
            --glass: blur(20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        /* --- Premium Pull-down Navigation --- */
        .top-navbar {
            height: 60px;
            background: rgba(10, 10, 12, 0.95);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 3000;
        }

        .logo {
            font-weight: 800;
            font-size: 1.3rem;
            letter-spacing: -0.5px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .logo span {
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Mobile Menu (Pull-down Overlay) */
        .mobile-menu-overlay {
            position: fixed;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 8, 0.98);
            backdrop-filter: blur(30px);
            z-index: 2500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            transition: top 0.5s cubic-bezier(0.7, 0, 0.3, 1);
            opacity: 0;
        }

        .mobile-menu-overlay.open {
            top: 0;
            opacity: 1;
        }

        .mobile-nav-item {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.3s;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-toggle {
            display: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            position: relative;
            z-index: 3100;
        }

        /* --- Main Content (Mobile-First) --- */
        .main-content {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .page-title h1 {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #aaa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .analysis-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .mobile-toggle {
                display: flex;
            }
        }

        @media (min-width: 769px) {
            .main-content {
                padding: 2rem;
            }

            header {
                flex-direction: row !important;
                justify-content: space-between;
                align-items: center;
            }

            .page-title h1 {
                font-size: 2.2rem;
            }

            .analysis-grid {
                display: grid;
                grid-template-columns: 2fr 1fr;
                grid-template-rows: 1fr 1fr;
            }
        }

        .card {
            background: var(--bg-panel);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Chart Area */
        .chart-container {
            flex: 1;
            position: relative;
            width: 100%;
        }

        /* Journal List */
        .journal-list {
            flex: 1;
            overflow-y: auto;
            border-top: 1px solid var(--border);
            margin-top: 10px;
            padding-top: 10px;
            padding-right: 5px;
            /* Space for scrollbar */
        }

        /* Custom Scrollbar for Journal */
        .journal-list::-webkit-scrollbar {
            width: 6px;
        }

        .journal-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }

        .journal-list::-webkit-scrollbar-thumb {
            background: rgba(0, 242, 255, 0.2);
            border-radius: 10px;
            transition: all 0.3s;
        }

        .journal-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .journal-entry {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            border-left: 3px solid var(--text-muted);
        }

        .journal-entry.work {
            border-left-color: var(--primary);
        }

        .journal-entry.harvest {
            border-left-color: var(--success);
        }

        .journal-entry.pest {
            border-left-color: var(--danger);
        }

        .journal-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .journal-content {
            color: var(--text-main);
        }

        /* Controls */
        .control-bar {
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 20px;
            border-radius: 15px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        input,
        select,
        textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 6px;
        }

        /* Fix Calendar Icon Visibility */
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        button.btn-primary {
            background: var(--primary);
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Top Navigation Bar -->
    <nav class="top-navbar">
        <div class="logo" onclick="location.href='/'">
            <i data-lucide="leaf" style="color:var(--primary)"></i>
            <span>MQ</span>net SmartFarm
        </div>

        <div class="nav-links">
            <a href="index.html" class="nav-item">ëŒ€ì‹œë³´ë“œ</a>
            <a href="cctv.html" class="nav-item">CCTV</a>
            <a href="dashboard.html" class="nav-item">ëª¨ë‹ˆí„°ë§</a>
            <a href="history.html" class="nav-item active">ë¶„ì„ì¼ì§€</a>
            <a href="infra_tree.html" class="nav-item">ì¸í”„ë¼</a>
            <a href="recipe_manager.html" class="nav-item">ìë™í™”</a>
        </div>

        <div class="mobile-toggle" id="menu-toggle">
            <i data-lucide="menu" id="menu-icon"></i>
        </div>
    </nav>

    <!-- Premium Pull-down Mobile Overlay -->
    <div class="mobile-menu-overlay" id="mobile-menu">
        <a href="index.html" class="mobile-nav-item">ëŒ€ì‹œë³´ë“œ</a>
        <a href="cctv.html" class="mobile-nav-item">ì‹¤ì‹œê°„ CCTV</a>
        <a href="dashboard.html" class="mobile-nav-item">ì„¼ì„œ ëª¨ë‹ˆí„°ë§</a>
        <a href="history.html" class="mobile-nav-item active">ë°ì´í„° ë¶„ì„ì¼ì§€</a>
        <a href="infra_tree.html" class="mobile-nav-item">ì¸í”„ë¼ ê´€ë¦¬</a>
        <a href="recipe_manager.html" class="mobile-nav-item">ìë™í™” ì„¤ì •</a>
        <a href="help.html" class="mobile-nav-item">ë„ì›€ë§ Center</a>
    </div>

    <main class="main-content">
        <header>
            <div class="page-title">
                <h1>ë°ì´í„° ë¶„ì„ ë° ì˜ë† ì¼ì§€</h1>
                <p>Data-driven Farming & Record Keeping</p>
            </div>
            <div class="system-status">
                <div class="status-pill">
                    <div class="status-dot"></div>
                    í™˜ê²½ ë™ê¸°í™” (Synced)
                </div>
                <div class="control-bar">
                    <input type="date" id="date-picker" onchange="loadData()">
                    <select id="zone-select">
                        <option value="A">Zone A (ìƒì¶”)</option>
                        <option value="B">Zone B (ìœ¡ë¬˜)</option>
                    </select>
                    <button class="btn-primary" onclick="loadData()"
                        style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="search" style="width: 14px; height: 14px;"></i> ì¡°íšŒ
                    </button>
                </div>
            </div>
        </header>

        <div class="analysis-grid">
            <!-- Chart Section -->
            <div class="card" style="grid-column: 1 / 2; grid-row: 1 / 2;">
                <div class="card-header">
                    <div class="card-title"><i data-lucide="line-chart"></i> í™˜ê²½ ë°ì´í„° ì¶”ì„¸ (Temp & Humidity)</div>
                    <select style="width: 120px;">
                        <option>ì˜¨ë„/ìŠµë„</option>
                        <option>CO2/ì¼ì¡°ëŸ‰</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="envChart"></canvas>
                </div>
            </div>

            <!-- Comparison / Insight Section -->
            <div class="card" style="grid-column: 1 / 2; grid-row: 2 / 3;">
                <div class="card-header">
                    <div class="card-title">
                        <i data-lucide="bar-chart-2"></i> ìƒìœ¡ ë¹„êµ ë° ì—ë„ˆì§€ ì†Œë¹„
                        <button onclick="runAnalysisAndOpen()" id="ai-btn"
                            style="margin-left:auto; font-size:0.7rem; padding:4px 12px; background:linear-gradient(135deg, var(--secondary), var(--primary)); border:none; color:white; border-radius:20px; cursor:pointer; font-weight:600; box-shadow:0 0 10px rgba(112,0,255,0.4); display:flex; align-items:center; gap:5px;">
                            <i data-lucide="sparkles" style="width:12px; height:12px;"></i> AI ë¶„ì„ ì‹¤í–‰
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>

            <!-- Journal Section -->
            <div class="card" style="grid-column: 2 / 3; grid-row: 1 / 3;">
                <div class="card-header">
                    <div class="card-title"><i data-lucide="book-open"></i> ìŠ¤ë§ˆíŠ¸ ì˜ë† ì¼ì§€</div>
                    <button class="btn-primary" onclick="addJournal()" style="font-size:0.8rem; padding:5px 10px;">+
                        ê¸°ë¡</button>
                </div>

                <!-- Quick input -->
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <select id="log-type" style="width:100%; margin-bottom:5px;">
                        <option value="work">ğŸ› ï¸ ì¼ë°˜ ì‘ì—… (Maintenance)</option>
                        <option value="harvest">ğŸŒ¾ ìˆ˜í™• (Harvest)</option>
                        <option value="pest">ğŸ› ë³‘í•´ì¶© ë°©ì œ (Pest Control)</option>
                    </select>
                    <textarea id="log-content" placeholder="ì‘ì—… ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                        style="width:100%; height:60px; resize:none;"></textarea>
                </div>

                <div class="journal-list" id="journal-container">
                    <!-- Dynamic Entries -->
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        var aiCharts = []; // Move to global top scope

        // --- Date Init ---
        document.getElementById('date-picker').valueAsDate = new Date();

        // --- Chart 1: Environment ---
        const ctxEnv = document.getElementById('envChart').getContext('2d');
        const envChart = new Chart(ctxEnv, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [
                    {
                        label: 'ì˜¨ë„ (Â°C)',
                        data: [18, 17, 19, 24, 25, 21, 19],
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'ìŠµë„ (%)',
                        data: [60, 65, 55, 45, 40, 55, 62],
                        borderColor: '#7000ff',
                        backgroundColor: 'rgba(112, 0, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8899ac' } } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8899ac' } },
                    x: { grid: { display: false }, ticks: { color: '#8899ac' } }
                }
            }
        });

        // --- Chart 2: Growth vs Energy ---
        const ctxGrowth = document.getElementById('growthChart').getContext('2d');
        const growthChart = new Chart(ctxGrowth, {
            type: 'bar',
            data: {
                labels: [], // Dynamic
                datasets: [
                    {
                        label: 'ìƒì¥ë¥  (Growth Ratio %)',
                        data: [],
                        backgroundColor: '#00ff9d',
                        yAxisID: 'y',
                    },
                    {
                        label: 'ì „ë ¥ ì†Œë¹„ (kWh)', // Still Dummy for now
                        data: [],
                        backgroundColor: '#ffb800',
                        yAxisID: 'y1',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8899ac' } } },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#00ff9d' },
                        title: { display: true, text: 'ìƒì¥ë¥  (%)', color: '#00ff9d' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#ffb800' },
                        title: { display: true, text: 'ì „ë ¥ (kWh)', color: '#ffb800' }
                    },
                    x: { grid: { display: false }, ticks: { color: '#8899ac' } }
                }
            }
        });

        async function fetchGrowthData() {
            try {
                const res = await fetch('/api/growth');
                if (!res.ok) return;

                const logs = await res.json();

                // Process Data: group by date or just show all points
                // Simple version: Show last 7 entries
                const recentLogs = logs.slice(-7);

                const labels = recentLogs.map(l => l.date.substring(5, 10)); // MM-DD
                const ratios = recentLogs.map(l => l.ratio);

                // Dummy Energy Data (Random for demo)
                const energies = recentLogs.map(() => Math.floor(Math.random() * 10) + 10);

                growthChart.data.labels = labels;
                growthChart.data.datasets[0].data = ratios;
                growthChart.data.datasets[1].data = energies;
                growthChart.update();

            } catch (e) {
                console.error("Growth Data Error: ", e);
            }
        }

        // Load initial data
        fetchGrowthData();

        // --- Journal Logic ---
        function renderJournal(journals) {
            const container = document.getElementById('journal-container');
            if (journals.length === 0) {
                container.innerHTML = `<div style="color:var(--text-muted); text-align:center; padding:20px;">ê¸°ë¡ëœ ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }
            container.innerHTML = journals.map(j => `
                <div class="journal-entry ${j.type}">
                    <div class="journal-date">${j.date}</div>
                    <div class="journal-content">${j.content}</div>
                </div>
            `).join('');
        }

        async function fetchJournal() {
            try {
                const res = await fetch('/api/journal');
                if (res.ok) {
                    const journals = await res.json();
                    renderJournal(journals);
                }
            } catch (e) {
                console.error("Journal Load Error:", e);
            }
        }

        async function addJournal() {
            const type = document.getElementById('log-type').value;
            const content = document.getElementById('log-content').value;
            if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const now = new Date().toLocaleString('ko-KR'); // Format nicely
            const entry = { type, date: now, content };

            try {
                const res = await fetch('/api/journal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });

                if (res.ok) {
                    document.getElementById('log-content').value = "";
                    fetchJournal(); // Refresh list
                } else {
                    alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error(e);
                alert("ì„œë²„ ì˜¤ë¥˜: " + e.message);
            }
        }

        // Initial Load
        fetchJournal();

        async function loadData() {
            const dateInput = document.getElementById('date-picker').value;
            if (!dateInput) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            try {
                // Fetch from Python Backend API
                const res = await fetch(`/api/history?date=${dateInput}`);
                if (!res.ok) throw new Error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

                const data = await res.json();

                // ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°
                if (data.temp.length === 0 && data.humi.length === 0) {
                    alert(`${dateInput} ë‚ ì§œì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }

                // Update Chart
                // labels: ì‹œê°„ì¶• (ê°„ë‹¨íˆ ëª¨ë“  ë°ì´í„°ì˜ ì‹œê°„ì„ í•©ì³ì„œ ì •ë ¬í•˜ê±°ë‚˜, í•˜ë‚˜ë¥¼ ê¸°ì¤€)
                // ì—¬ê¸°ì„œëŠ” temp ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ì¶• ì¬ì„¤ì •
                const labels = data.temp.map(d => d.t);
                const temps = data.temp.map(d => d.y);
                const humis = data.humi.map(d => d.y); // ì£¼ì˜: ì‹œê°„ì¶•ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ, ì‹¤ì œë¡  ë§¤ì¹­ í•„ìš”

                envChart.data.labels = labels;
                envChart.data.datasets[0].data = temps; // Temp
                envChart.data.datasets[1].data = humis; // Humi (Optional: might mismatch length)

                envChart.update();
                alert("ë°ì´í„° ì¡°íšŒ ì™„ë£Œ!");

            } catch (e) {
                console.error(e);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + e.message);
            }
        }

        renderJournal();

        // --- AI Report Logic (v2.5: Dynamic Chart.js) ---

        async function runAnalysisAndOpen() {
            const btn = document.getElementById('ai-btn');
            const originalHTML = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = `<span style="animation: spin 1s linear infinite;">â³</span> AI ê³„ì‚° ì¤‘...`;

                const res = await fetch('/api/run_model', { method: 'POST' });
                if (!res.ok) throw new Error("ë¶„ì„ ì„œë²„ ì˜¤ë¥˜");
                const data = await res.json();
                if (!data.success) throw new Error(data.error || "ë¶„ì„ ì‹¤íŒ¨");

                openAIModalWithData(data);
            } catch (e) {
                alert("ë¶„ì„ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function openAIModalWithData(data) {
            // v4.2: ì •ë°€ ì—ëŸ¬ ì§„ë‹¨ ë° ë³µì‚¬ ê°€ëŠ¥í•œ ì—ëŸ¬ í‘œì‹œ
            if (!data || !data.dates || data.success === false) {
                const errorDetail = data ? (data.error || "ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.") : "ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.";
                console.error("AI Data Error Detail:", data);
                // ë³µì‚¬ ê°€ëŠ¥í•˜ë„ë¡ alert ëŒ€ì‹  promptë‚˜ ì»¤ìŠ¤í…€ ì°½ì„ ê³ ë ¤í•  ìˆ˜ ìˆìœ¼ë‚˜, íŒì—…ì°½ì— ì—ëŸ¬ì½”ë“œ í¬í•¨
                const msg = "[ë¶„ì„ ì‹¤íŒ¨]\nì‚¬ìœ : " + errorDetail + "\n\nì´ ë©”ì‹œì§€ë¥¼ ë³µì‚¬í•˜ì—¬ AIì—ê²Œ ì•Œë ¤ì£¼ì„¸ìš”.";
                alert(msg);
                return;
            }

            document.getElementById('aiModal').style.display = 'flex';
            if (window.aiCharts && Array.isArray(window.aiCharts)) {
                window.aiCharts.forEach(c => { if (c) c.destroy(); });
            }
            window.aiCharts = [];

            // ìµœê·¼ 10ì¼ê°„ì˜ ë°ì´í„°ë¡œ ìŠ¬ë¼ì´ì‹±
            const daysToView = 10;
            const labels = data.dates.slice(-daysToView);

            const chartsConfig = [
                {
                    id: 'aiC1', type: 'line', label: 'ìƒìœ¡ì„±ì¥ ì¶”ì„¸ (%)',
                    data: data.dates.map(d => {
                        const idx = data.measured_growth.dates.indexOf(d);
                        return idx !== -1 ? data.measured_growth.ratios[idx] : null;
                    }).slice(-daysToView),
                    color: '#ff4b5c'
                },
                {
                    id: 'aiC2', type: 'line', datasets: [
                        { label: 'ì˜¨ë„ (Â°C)', data: data.temp.slice(-daysToView), borderColor: '#ffa726', borderWidth: 2, tension: 0.4 },
                        { label: 'ìŠµë„ (%)', data: data.humi.slice(-daysToView), borderColor: '#29b6f6', borderWidth: 2, tension: 0.4 }
                    ]
                },
                {
                    id: 'aiC3', type: 'bar', label: 'ê´‘ëŸ‰ (PPFD)',
                    data: data.light.slice(-daysToView),
                    color: 'rgba(255, 235, 59, 0.6)'
                },
                {
                    id: 'aiC4', type: 'line', datasets: [
                        { label: 'EC (ì˜ì–‘ì•¡)', data: data.ec.slice(-daysToView), borderColor: '#ba68c8', borderWidth: 2 },
                        { label: 'pH (ì‚°ë„)', data: data.ph.slice(-daysToView), borderColor: '#4db6ac', borderWidth: 2 }
                    ]
                }
            ];

            chartsConfig.forEach(cfg => {
                const ctx = document.getElementById(cfg.id).getContext('2d');
                const datasets = cfg.datasets || [{
                    label: cfg.label,
                    data: cfg.data,
                    borderColor: cfg.color,
                    backgroundColor: cfg.color,
                    borderWidth: 5,
                    pointRadius: 6,
                    pointBackgroundColor: cfg.color,
                    tension: 0.4
                }];
                aiCharts.push(new Chart(ctx, {
                    type: cfg.type,
                    data: { labels: labels, datasets: datasets },
                    options: commonOptions
                }));
            });
        }

        function closeAIModal() { document.getElementById('aiModal').style.display = 'none'; }

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
            .ai-box { height: 224px !important; min-height: 224px !important; margin-bottom: 35px !important; background: rgba(255,255,255,0.01); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.03); display: block !important; width: 100% !important; }
        `;
        // Premium Pull-down Menu Toggle
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuIcon = document.getElementById('menu-icon');

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                const isOpen = mobileMenu.classList.toggle('open');
                menuIcon.setAttribute('data-lucide', isOpen ? 'x' : 'menu');
                lucide.createIcons();
                document.body.style.overflow = isOpen ? 'hidden' : 'auto';
            });
        }

        lucide.createIcons();
    </script>

    <div id="aiModal"
        style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter:blur(15px); justify-content:center; align-items:center; overflow-y:auto; padding:20px;">
        <div
            style="max-width:800px; width:80%; background:#08080a; border:1px solid rgba(255,255,255,0.1); border-radius:20px; padding:25px; box-shadow:0 30px 60px rgba(0,0,0,1); position:relative;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-size:1.1rem; color:#fff; display:flex; align-items:center; gap:10px;"><i
                        data-lucide="sparkles" style="color:var(--primary); width:18px;"></i> AI ì •ë°€ ë¨¸ì‹ ëŸ¬ë‹ ë¦¬í¬íŠ¸ <span
                        style="font-size:0.7rem; color:var(--primary); opacity:0.7;">v3.2</span>
                </h2>
                <button onclick="closeAIModal()"
                    style="background:rgba(255,255,255,0.05); border:none; color:#fff; width:30px; height:30px; border-radius:50%; cursor:pointer; font-size:24px; line-height:1;">&times;</button>
            </div>
            <div class="ai-box" style="height:160px !important; margin-bottom:15px;"><canvas id="aiC1"></canvas></div>
            <div class="ai-box" style="height:160px !important; margin-bottom:15px;"><canvas id="aiC2"></canvas></div>
            <div class="ai-box" style="height:160px !important; margin-bottom:15px;"><canvas id="aiC3"></canvas></div>
            <div class="ai-box" style="height:160px !important; margin-bottom:15px;"><canvas id="aiC4"></canvas></div>
        </div>
    </div>
</body>

</html>