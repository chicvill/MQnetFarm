<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ì¸í”„ë¼ ê´€ë¦¬ (Infrastructure) - SmartFarm</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(20, 20, 25, 0.6);
            --primary: #00f2ff;
            --secondary: #7000ff;
            --success: #00ff9d;
            --warning: #ffb800;
            --danger: #ff0055;
            --text-main: #ffffff;
            --text-muted: #8899ac;
            --border: rgba(255, 255, 255, 0.08);
            --glass: blur(20px);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* --- Premium Pull-down Navigation --- */
        .top-navbar {
            height: 60px;
            background: rgba(10, 10, 12, 0.95);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 3000;
        }

        .logo {
            font-weight: 800;
            font-size: 1.3rem;
            letter-spacing: -0.5px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .logo span {
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Mobile Menu (Pull-down Overlay) */
        .mobile-menu-overlay {
            position: fixed;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 8, 0.98);
            backdrop-filter: blur(30px);
            z-index: 2500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            transition: top 0.5s cubic-bezier(0.7, 0, 0.3, 1);
            opacity: 0;
        }

        .mobile-menu-overlay.open {
            top: 0;
            opacity: 1;
        }

        .mobile-nav-item {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.3s;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-toggle {
            display: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            position: relative;
            z-index: 3100;
        }

        /* --- Main Content (Mobile-First) --- */
        .main-content {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .mobile-toggle {
                display: flex;
            }

            .drawer {
                width: 100% !important;
                right: -100% !important;
            }

            .drawer.open {
                right: 0 !important;
            }
        }

        @media (min-width: 769px) {
            .main-content {
                padding: 2rem;
            }

            header {
                flex-direction: row !important;
                justify-content: space-between;
                align-items: center;
            }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #fff, #aaa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-title p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .icon-gradient {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- Tree Structure --- */
        .tree-container {
            max-width: 800px;
        }

        .tree-item {
            margin-bottom: 15px;
            user-select: none;
        }

        .tree-header {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .tree-header:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
            transform: translateX(5px);
        }

        .tree-header.active {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }

        .tree-toggle {
            margin-right: 15px;
            width: 20px;
            text-align: center;
            transition: transform 0.3s ease;
            color: var(--text-dim);
        }

        .tree-toggle.open {
            transform: rotate(90deg);
        }

        .tree-icon {
            margin-right: 15px;
            font-size: 1.2rem;
        }

        .tree-label {
            flex: 1;
            font-weight: 500;
        }

        .tree-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-dim);
        }

        .tree-children {
            margin-left: 40px;
            margin-top: 10px;
            padding-left: 20px;
            border-left: 1px solid var(--border);
            display: none;
        }

        .tree-children.show {
            display: block;
        }

        /* --- Sliding Drawer --- */
        .drawer {
            width: 450px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border);
            position: fixed;
            right: -450px;
            top: 0;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            box-shadow: -20px 0 50px rgba(0, 0, 0, 0.5);
        }

        .drawer.open {
            right: 0;
        }

        .drawer-header {
            padding: 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-close {
            cursor: pointer;
            color: var(--text-dim);
            font-size: 1.5rem;
            transition: color 0.2s;
        }

        .drawer-close:hover {
            color: var(--danger);
        }

        .drawer-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .detail-title {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .detail-label {
            color: var(--text-dim);
        }

        .detail-value {
            font-weight: 500;
            color: var(--text-main);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .device-list {
            list-style: none;
        }

        .device-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .device-item .icon {
            margin-right: 12px;
        }

        .device-item .info {
            flex: 1;
        }

        .device-item .name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .device-item .meta {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* --- Tooltip --- */
        [data-tooltip] {
            position: relative;
            cursor: pointer;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            background: #000;
            color: #fff;
            font-size: 0.7rem;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body>

    <!-- Top Navigation Bar -->
    <nav class="top-navbar">
        <div class="logo" onclick="location.href='/'">
            <i data-lucide="leaf" style="color:var(--primary)"></i>
            <span>MQ</span>net SmartFarm
        </div>

        <div class="nav-links">
            <a href="index.html" class="nav-item">ëŒ€ì‹œë³´ë“œ</a>
            <a href="cctv.html" class="nav-item">CCTV</a>
            <a href="dashboard.html" class="nav-item">ëª¨ë‹ˆí„°ë§</a>
            <a href="history.html" class="nav-item">ë¶„ì„ì¼ì§€</a>
            <a href="infra_tree.html" class="nav-item active">ì¸í”„ë¼</a>
            <a href="recipe_manager.html" class="nav-item">ìë™í™”</a>
        </div>

        <div class="mobile-toggle" id="menu-toggle">
            <i data-lucide="menu" id="menu-icon"></i>
        </div>
    </nav>

    <!-- Premium Pull-down Mobile Overlay -->
    <div class="mobile-menu-overlay" id="mobile-menu">
        <a href="index.html" class="mobile-nav-item">ëŒ€ì‹œë³´ë“œ</a>
        <a href="cctv.html" class="mobile-nav-item">ì‹¤ì‹œê°„ CCTV</a>
        <a href="dashboard.html" class="mobile-nav-item">ì„¼ì„œ ëª¨ë‹ˆí„°ë§</a>
        <a href="history.html" class="mobile-nav-item">ë°ì´í„° ë¶„ì„ì¼ì§€</a>
        <a href="infra_tree.html" class="mobile-nav-item active">ì¸í”„ë¼ ê´€ë¦¬</a>
        <a href="recipe_manager.html" class="mobile-nav-item">ìë™í™” ì„¤ì •</a>
        <a href="help.html" class="mobile-nav-item">ë„ì›€ë§ Center</a>
    </div>

    <main class="main-content">
        <header>
            <div class="page-title">
                <h1>ì¸í”„ë¼ ê´€ë¦¬ (Infrastructure Tree)</h1>
                <p>Hierarchy & Device Management System</p>
            </div>
        </header>

        <div id="treeViewport" class="tree-container">
            <!-- Tree items injected here -->
        </div>
    </main>

    <!-- Sliding Drawer -->
    <div id="sideDrawer" class="drawer">
        <div class="drawer-header">
            <h2 id="drawerTitle">Infrastructure Detail</h2>
            <span class="drawer-close" onclick="closeDrawer()">&times;</span>
        </div>
        <div id="drawerContent" class="drawer-content">
            <!-- Details injected here -->
        </div>
    </div>

    <script>
        const DRAWER = document.getElementById('sideDrawer');
        const VIEWPORT = document.getElementById('treeViewport');

        // ì¶”ê°€ ë°ì´í„° ì €ì¥ì†Œ
        let fullConfig = [];
        let zoneConfigs = [];
        let gatewayConfigs = [];
        let cropCatalog = {};
        let totalFarmProfit = 0;

        async function loadHierarchy() {
            try {
                // ì„¤ì • íŒŒì¼ë“¤ì„ ë³‘ë ¬ë¡œ ë¡œë“œ
                const [nodes, zones, gateways, crops] = await Promise.all([
                    fetch('/data/config.json').then(r => r.json()),
                    fetch('/data/zone_config.json').then(r => r.json()),
                    fetch('/data/gateway_config.json').then(r => r.json()),
                    fetch('/data/catalog_crop.json').then(r => r.json())
                ]);

                fullConfig = nodes;
                zoneConfigs = zones;
                gatewayConfigs = gateways;
                cropCatalog = crops;

                // êµ¬ì—­-ê²Œì´íŠ¸ì›¨ì´-ë…¸ë“œ ë§µ ì‘ì„±ì„ ìœ„í•œ ë°ì´í„° ë³‘í•©
                const zoneMap = {};

                // 1. êµ¬ì—­ ê¸°ë°˜ êµ¬ì¡° ìƒì„±
                zoneConfigs.forEach(z => {
                    zoneMap[z.id] = { ...z, gateways: {} };
                });

                // 2. ê²Œì´íŠ¸ì›¨ì´ ì •ë³´ ë§¤í•‘ (êµ¬ì—­ í•˜ìœ„ì— ê²Œì´íŠ¸ì›¨ì´ ë°°ì¹˜)
                gatewayConfigs.forEach(gw => {
                    const zoneId = gw.id.substring(0, 2);
                    if (zoneMap[zoneId]) {
                        zoneMap[zoneId].gateways[gw.id] = { ...gw, nodes: [] };
                    }
                });

                // 3. ë…¸ë“œ ì •ë³´ ë§¤í•‘ (ê²Œì´íŠ¸ì›¨ì´ í•˜ìœ„ì— ë…¸ë“œ ë°°ì¹˜)
                fullConfig.forEach(node => {
                    const zoneId = node.id.substring(0, 2);
                    const gwId = node.id.substring(0, 2); // ì˜ˆì‹œ: AA êµ¬ì—­ì˜ ë…¸ë“œëŠ” AA ê²Œì´íŠ¸ì›¨ì´ì— ì†í•¨

                    if (zoneMap[zoneId]) {
                        // ê²Œì´íŠ¸ì›¨ì´ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ì„ì‹œ ìƒì„±
                        if (!zoneMap[zoneId].gateways[gwId]) {
                            zoneMap[zoneId].gateways[gwId] = { id: gwId, name: `GW-${gwId}`, nodes: [] };
                        }
                        zoneMap[zoneId].gateways[gwId].nodes.push(node);
                    }
                });

                renderTree(zoneMap);
            } catch (error) {
                console.error("Hierarchy Load Error:", error);
            }
        }

        function renderTree(zoneMap) {
            VIEWPORT.innerHTML = '';

            // ì „ì—­ ìˆ˜ìµ í•©ì‚° ê³„ì‚°
            totalFarmProfit = 0;
            Object.values(zoneMap).forEach(z => {
                const nodeCount = Object.values(z.gateways).reduce((acc, gw) => acc + gw.nodes.length, 0);
                const eco = z.economy || { yield_per_node: 0, price_per_kg: 0, loss_rate: 0 };
                z.computedProfit = (eco.yield_per_node * nodeCount * eco.price_per_kg) * (1 - eco.loss_rate / 100);
                totalFarmProfit += z.computedProfit;
            });

            Object.values(zoneMap).forEach(zone => {
                const currentStage = getCurrentStage(zone.schedule || {});
                const share = totalFarmProfit > 0 ? ((zone.computedProfit / totalFarmProfit) * 100).toFixed(1) : 0;
                const zoneRecipeLabel = `${zone.crop || 'none'}.${currentStage}`;

                const zoneEl = createTreeItem({
                    id: zone.id,
                    type: 'ZONE',
                    icon: 'ğŸ“¦',
                    label: `${zone.name || 'Zone ' + zone.id} (${zone.crop || 'none'})`,
                    badge: `${currentStage.toUpperCase()} | â‚©${zone.computedProfit.toLocaleString()} (${share}%)`,
                    data: zone
                });

                const zoneChildrenContainer = zoneEl.querySelector('.tree-children');

                // ê²Œì´íŠ¸ì›¨ì´ ë Œë”ë§
                Object.values(zone.gateways).forEach(gw => {
                    const gwEl = createTreeItem({
                        id: gw.id,
                        type: 'GATEWAY',
                        icon: 'ğŸŒ',
                        label: `Gateway ${gw.id}`,
                        badge: `${gw.nodes.length} Nodes`,
                        data: gw
                    });
                    zoneChildrenContainer.appendChild(gwEl);

                    const gwChildrenContainer = gwEl.querySelector('.tree-children');
                    // ë…¸ë“œ ë Œë”ë§
                    gw.nodes.forEach(node => {
                        const nodeData = { ...node, zoneCrop: zone.crop || 'none', zoneSchedule: zone.schedule };
                        // ìƒì†ëœ ì‘ë¬¼ì— í˜„ì¬ ë‹¨ê³„ í‘œì‹œ ë¡œì§ ì¶”ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ. ì§€ê¸ˆì€ ê°„ë‹¨íˆ í‘œì‹œ.
                        const displayRecipe = node.recipe || `${zoneRecipeLabel} (Inherited)`;

                        const nodeEl = createTreeItem({
                            id: node.id,
                            type: 'NODE',
                            icon: 'ğŸŸ¢',
                            label: `Node ${node.id}`,
                            badge: displayRecipe,
                            data: nodeData
                        });
                        gwChildrenContainer.appendChild(nodeEl);
                    });
                });

                VIEWPORT.appendChild(zoneEl);
            });
        }

        function getCurrentStage(schedule) {
            if (!schedule || Object.keys(schedule).length === 0) return "n/a";
            const now = new Date();
            const dates = Object.entries(schedule)
                .map(([k, v]) => ({ key: k, date: new Date(v) }))
                .sort((a, b) => b.date - a.date);
            for (let d of dates) {
                if (now >= d.date) return d.key;
            }
            return "sowing";
        }

        function createTreeItem({ id, type, icon, label, badge, data }) {
            const item = document.createElement('div');
            item.className = 'tree-item';
            const dataStr = JSON.stringify(data).replace(/"/g, '&quot;');

            item.innerHTML = `
                <div class="tree-header" onclick="handleItemClick(event, this, '${type}', ${dataStr})">
                    <span class="tree-toggle">â–¶</span>
                    <span class="tree-icon">${icon}</span>
                    <span class="tree-label">${label}</span>
                    <span class="tree-badge">${badge}</span>
                    <div class="tree-actions" style="margin-left: 10px; display: flex; gap: 5px;">
                        ${type !== 'NODE' ? `<button data-tooltip="${type === 'ZONE' ? 'ê²Œì´íŠ¸ì›¨ì´ ì¶”ê°€' : 'ë…¸ë“œ ì¶”ê°€'}" onclick="handleAdd(event, '${type}', '${id}')" style="background:var(--primary); border:none; color:white; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:10px">+</button>` : ''}
                        <button data-tooltip="${type} ì‚­ì œ" onclick="handleDelete(event, '${type}', '${id}')" style="background:var(--danger); border:none; color:white; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:10px">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="tree-children"></div>
            `;
            return item;
        }

        function handleAdd(e, type, parentId) {
            e.stopPropagation();
            alert(`${parentId} í•˜ìœ„ì— ìƒˆë¡œìš´ ${type === 'ZONE' ? 'GATEWAY' : 'NODE'}ë¥¼ ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤.`);
            // ì—¬ê¸°ì— ì‹¤ì œ JSON ìˆ˜ì • ë° sync ë¡œì§ ì¶”ê°€ ì˜ˆì •
        }

        function handleDelete(e, type, id) {
            e.stopPropagation();
            if (confirm(`${type} ${id}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                alert(`${id} ì‚­ì œ ìš”ì²­ë¨.`);
            }
        }

        function handleItemClick(e, header, type, data) {
            e.stopPropagation();
            const toggle = header.querySelector('.tree-toggle');
            const children = header.nextElementSibling;
            if (children && (children.children.length > 0 || type === 'GATEWAY')) {
                toggle.classList.toggle('open');
                children.classList.toggle('show');
            }
            document.querySelectorAll('.tree-header').forEach(h => h.classList.remove('active'));
            header.classList.add('active');
            showDetails(type, data);
        }

        function showDetails(type, data) {
            const title = document.getElementById('drawerTitle');
            const content = document.getElementById('drawerContent');
            DRAWER.classList.add('open');
            title.innerText = `${type} ì •ë³´ ë° ì„¤ì •`;

            if (type === 'ZONE') {
                const currentStage = getCurrentStage(data.schedule || {});
                const stagesHtml = Object.entries(data.schedule || {}).map(([k, v]) => {
                    const isCurrent = k === currentStage;
                    const highlightStyle = isCurrent ? 'border: 1px solid var(--accent); background: rgba(245, 158, 11, 0.1);' : '';
                    const labelStyle = isCurrent ? 'color: var(--accent); font-weight: bold;' : 'color: var(--text-dim);';

                    // í•´ë‹¹ ë‹¨ê³„ì˜ ë ˆì‹œí”¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    let recipeInfo = '';
                    if (data.crop && cropCatalog[data.crop] && cropCatalog[data.crop][k]) {
                        const r = cropCatalog[data.crop][k];
                        recipeInfo = `<div style="font-size:0.7rem; color:#aaa; margin-top:4px">
                            Temp: ${r.Temp?.min}~${r.Temp?.max}â„ƒ | pH: ${r.pH?.min}~${r.pH?.max}
                        </div>`;
                    }

                    return `
                    <div style="margin-bottom:10px; padding: 10px; border-radius: 8px; ${highlightStyle}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <label style="font-size:0.75rem; ${labelStyle}">${k.toUpperCase()}${isCurrent ? ' (Current)' : ''}</label>
                            <input type="date" value="${v}" style="padding:6px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:white; border-radius:6px; font-size:0.8rem;">
                        </div>
                        ${recipeInfo}
                    </div>
                `}).join('');

                content.innerHTML = `
                    <div class="detail-card">
                        <div class="detail-title">ğŸ“ êµ¬ì—­ ê¸°ë³¸ ì •ë³´</div>
                        <div class="detail-row"><span class="detail-label">êµ¬ì—­ëª…</span><span class="detail-value">${data.name || data.id}</span></div>
                        <div style="margin-top:10px">
                            <label style="font-size:0.75rem; color:var(--text-dim)">ì¬ë°° ì‘ë¬¼</label>
                            <select id="zone-crop-select" style="width:100%; padding:10px; background:#1e293b; border:1px solid var(--primary); color:var(--primary); font-weight:600; border-radius:6px">
                                ${Object.keys(cropCatalog).map(c => `<option value="${c}" ${data.crop === c ? 'selected' : ''}>${c.toUpperCase()}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-title">ğŸ“… ì¬ë°° ì¼ì • (Life-cycle)</div>
                        ${stagesHtml}
                    </div>

                    <div class="detail-card" style="border-left: 4px solid var(--accent)">
                        <div class="detail-title">ğŸ’° ì˜ˆìƒ ìˆ˜ìµ ê³„ì‚°ê¸°</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                            <div><label style="font-size:0.7rem; color:var(--text-dim)">ìƒì‚°ëŸ‰(kg)</label><input type="number" value="${data.economy?.yield_per_node || 0}" style="width:100%; padding:8px; background:transparent; border:1px solid var(--border); color:white"></div>
                            <div><label style="font-size:0.7rem; color:var(--text-dim)">ë‹¨ê°€(ì›/kg)</label><input type="number" value="${data.economy?.price_per_kg || 0}" style="width:100%; padding:8px; background:transparent; border:1px solid var(--border); color:white"></div>
                        </div>
                        <div style="margin-top:10px">
                            <label style="font-size:0.7rem; color:var(--text-dim)">ì†ì‹¤ìœ¨ (Loss %)</label>
                            <input type="number" value="${data.economy?.loss_rate || 0}" style="width:100%; padding:8px; background:transparent; border:1px solid var(--border); color:white; border-radius:4px">
                        </div>
                        <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border)">
                            <div style="display:flex; justify-content:space-between"><span>ì˜ˆìƒ ìˆœì´ìµ</span><span style="color:var(--primary); font-weight:700">â‚© ${(data.computedProfit || 0).toLocaleString()}</span></div>
                        </div>
                    </div>
                    <button onclick="handleSaveAndClose('êµ¬ì—­ ì •ì±…', 'ZONE', '${data.id}')" style="width:100%; padding:12px; background:var(--primary); border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer">êµ¬ì—­ ì •ì±… ì €ì¥</button>
                `;
            } else if (type === 'GATEWAY') {
                content.innerHTML = `
                    <div class="detail-card">
                        <div class="detail-title">ğŸŒ ê²Œì´íŠ¸ì›¨ì´ í†µì‹  ì„¤ì •</div>
                        <div style="margin-bottom:15px">
                            <label style="font-size:0.75rem; color:var(--text-dim)">MAC Address</label>
                            <input type="text" value="${data.mac || '5C:CF:7F:XX:XX:XX'}" style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:var(--accent); font-family:monospace; border-radius:6px">
                        </div>
                        <div style="margin-bottom:15px">
                            <label style="font-size:0.75rem; color:var(--text-dim)">WiFi SSID</label>
                            <input type="text" value="${data.wifi_ssid || ''}" style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:white; border-radius:6px">
                        </div>
                        <div style="margin-bottom:15px">
                            <label style="font-size:0.75rem; color:var(--text-dim)">WiFi Password</label>
                            <input type="password" value="${data.wifi_pw || ''}" style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:white; border-radius:6px">
                        </div>
                        <div style="margin-bottom:15px">
                            <label style="font-size:0.75rem; color:var(--text-dim)">MQTT Broker IP</label>
                            <input type="text" value="${data.mqtt_broker || '192.168.0.XX'}" style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:var(--secondary); font-family:monospace; border-radius:6px">
                        </div>
                    </div>
                    <button onclick="handleSaveAndClose('ê²Œì´íŠ¸ì›¨ì´ ì„¤ì •')" style="width:100%; padding:12px; background:var(--secondary); border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer">ê²Œì´íŠ¸ì›¨ì´ ì„¤ì • ì ìš©</button>
                `;
            } else {
                const sensors = data.sensors || [];
                const actuators = data.actuators || [];
                const today = new Date().toISOString().split('T')[0];
                const currentStage = getCurrentStage(data.zoneSchedule) || "n/a";

                content.innerHTML = `
                    <div class="detail-card">
                        <div class="detail-title">ğŸ› ï¸ Node Specification</div>
                        <div class="detail-row"><span class="detail-label">Node ID</span><span class="detail-value">${data.id}</span></div>
                        <div class="detail-row"><span class="detail-label">Today</span><span class="detail-value">${today}</span></div>
                        <div class="detail-row"><span class="detail-label">Current Stage</span><span class="detail-value" style="color:var(--accent); font-weight:700">${currentStage.toUpperCase()}</span></div>
                        <div class="detail-row"><span class="detail-label">Current Recipe</span><span class="detail-value" style="color:var(--primary); font-weight:700">${data.recipe || (data.zoneCrop + ' (ìƒì†)')}</span></div>
                        <div style="margin-top:15px">
                            <label style="font-size:0.75rem; color:var(--text-dim)">ESP-NOW MAC Address</label>
                            <input type="text" value="${data.mac || ''}" placeholder="7C:DF:A1:XX:XX:XX" style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:var(--accent); font-family:monospace; border-radius:6px; margin-top:5px">
                        </div>
                    </div>

                    <div class="detail-card" style="background:rgba(59, 130, 246, 0.1); border:1px solid var(--secondary)">
                        <div class="detail-title" style="color:var(--secondary)">âš™ï¸ ë…¸ë“œ ìƒì„¸ ì„¤ì • (Node Config)</div>
                        <p style="font-size:0.8rem; color:var(--text-dim); margin-bottom:15px">ì´ ë…¸ë“œì— ì—°ê²°ëœ ì„¼ì„œë‚˜ ì¥ì¹˜ë¥¼ ì¶”ê°€/ë³€ê²½í•˜ê±°ë‚˜, í•€ ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                        <button onclick="window.open('configurator.html?node=${data.id}', '_blank')" style="width:100%; padding:10px; background:var(--secondary); border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer">ìƒì„¸ ì„¤ì • ì—´ê¸°</button>
                    </div>

                    <div class="detail-title">ğŸ“¡ ì—°ê²°ëœ ì¥ì¹˜ í˜„í™©</div>
                    <div class="device-list">
                        ${sensors.map((s, idx) => `
                            <div class="device-item">
                                <span class="icon">ğŸ“¡</span>
                                <div class="info">
                                    <div class="name">${s.name}</div>
                                    <div class="meta">ID: ${s.id}</div>
                                    <div class="meta" style="color:var(--accent)">Range: ${s.min} ~ ${s.max}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${actuators.map((a, idx) => `<div class="device-item"><span class="icon">âš™ï¸</span><div class="info"><div class="name">${a.name}</div><div class="meta">ID: ${a.id}</div></div></div>`).join('')}
                    </div>
                    
                    <button onclick="handleSaveAndClose('ë…¸ë“œ í†µì‹  ì •ë³´')" style="width:100%; padding:12px; background:var(--primary); border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer; margin-top:20px">í†µì‹  ì„¤ì • ì €ì¥</button>
                `;
            }
        }

        function handleSaveAndClose(label, type, id) {
            if (label === 'êµ¬ì—­ ì •ì±…' && id) {
                const zone = Object.values(zoneConfigs).find(z => z.id === id); // Find in raw zoneConfigs array/object
                if (zone) {
                    const cropSelect = document.getElementById('zone-crop-select');
                    if (cropSelect) {
                        zone.crop = cropSelect.value;
                        // Re-render to show changes
                        // Need to re-merge data because renderTree takes a map structure
                        // For simplicity, let's reload the whole hierarchy or manually update the map passed to renderTree.
                        // Since we have 'zoneConfigs' which is one of the sources for 'loadHierarchy', 
                        // calling loadHierarchy() again would re-fetch from file, wiping changes unless we save to file.
                        // So we must update the in-memory structure derived from zoneConfigs.

                        // Ideally, we'd POST this change to the server. 
                        // Here we'll simulate it by alerting and refreshing the tree with the local change.

                        // Manually finding the zone in the map would be better if we had access to 'zoneMap' globally.
                        // But 'zoneMap' is local to 'loadHierarchy'.
                        // Let's modify 'loadHierarchy' to be split into 'fetchData' and 'buildTree'.
                        // For now, let's just cheat and update the DOM or reload using local modified data? 
                        // Actually, let's just accept that without a backend save, a page refresh clears this.
                        // To make it "work" in the session, we need to update the data source that renderTree uses.

                        // Let's refactor slightly to keep zoneMap global or re-derivable.
                        // See next steps for refactoring. This replacement handles the button click better.
                    }
                }
            }
            alert(`${label}ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹¤ì œ íŒŒì¼ ì €ì¥ ê¸°ëŠ¥ì€ ë°±ì—”ë“œ ì—°ë™ í•„ìš”)`);

            // For now, simple reload to see if it persists (it won't without backend). 
            // BUT user said "changed but not applied".
            // So we need to update the UI immediately.

            // Let's trigger a re-build of the tree using the current (modified) variables.
            // But we need to update the specific zone in 'zoneConfigs' first.
            if (type === 'ZONE') {
                const newCrop = document.getElementById('zone-crop-select').value;
                const targetZone = zoneConfigs.find(z => z.id === id);
                if (targetZone) targetZone.crop = newCrop;

                // --- Threshold Update Logic Start ---
                try {
                    const currentStage = getCurrentStage(targetZone.schedule) || "growth"; // fallback
                    if (cropCatalog[newCrop] && cropCatalog[newCrop][currentStage]) {
                        const recipe = cropCatalog[newCrop][currentStage];

                        // Update ALL nodes under this zone that inherit the crop
                        fullConfig.forEach(node => {
                            // Check if node belongs to this zone (first 2 chars of ID)
                            if (node.id.startsWith(id)) {
                                // Only update if node doesn't have a specific override recipe
                                if (!node.recipe) {
                                    if (node.sensors) {
                                        node.sensors.forEach(sensor => {
                                            // Match sensor name with recipe param key (case-insensitive for safety)
                                            // Crop keys: "Temp", "pH", etc. Sensor names: likely "Temp", "pH"
                                            const key = Object.keys(recipe).find(k => k.toLowerCase() === sensor.name.toLowerCase());
                                            if (key) {
                                                sensor.min = recipe[key].min;
                                                sensor.max = recipe[key].max;
                                                // Mark change for visual confirmation
                                                console.log(`Updated Node ${node.id} Sensor ${sensor.name} -> [${sensor.min}, ${sensor.max}]`);
                                            }
                                        });
                                    }
                                }
                            }
                        });
                        alert(`êµ¬ì—­ ${id}ì˜ ì‘ë¬¼ì´ '${newCrop}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„ê³„ê°’ì´ ë…¸ë“œ ${fullConfig.filter(n => n.id.startsWith(id)).length}ê°œì— ì „íŒŒë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                } catch (e) {
                    console.error("Threshold update failed", e);
                }
                // --- Threshold Update Logic End ---

                // Re-build map and render switch logic remains same
                const zoneMap = {};
                zoneConfigs.forEach(z => { zoneMap[z.id] = { ...z, gateways: {} }; });
                gatewayConfigs.forEach(gw => {
                    const zoneId = gw.id.substring(0, 2);
                    if (zoneMap[zoneId]) zoneMap[zoneId].gateways[gw.id] = { ...gw, nodes: [] };
                });
                fullConfig.forEach(node => {
                    const zoneId = node.id.substring(0, 2);
                    const gwId = node.id.substring(0, 2);
                    if (zoneMap[zoneId]) {
                        if (!zoneMap[zoneId].gateways[gwId]) zoneMap[zoneId].gateways[gwId] = { id: gwId, name: `GW-${gwId}`, nodes: [] };
                        zoneMap[zoneId].gateways[gwId].nodes.push(node);
                    }
                });
                renderTree(zoneMap);
            }

            closeDrawer();
        }

        function closeDrawer() {
            DRAWER.classList.remove('open');
            document.querySelectorAll('.tree-header').forEach(h => h.classList.remove('active'));
        }

        // Premium Pull-down Menu Toggle
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuIcon = document.getElementById('menu-icon');

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                const isOpen = mobileMenu.classList.toggle('open');
                menuIcon.setAttribute('data-lucide', isOpen ? 'x' : 'menu');
                lucide.createIcons();
                document.body.style.overflow = isOpen ? 'hidden' : 'auto';
            });
        }

        lucide.createIcons();
        loadHierarchy();
    </script>
</body>

</html>